---
title: "Action Potential Analysis"
output: rmarkdown::html_vignette
description: >
  Learn how to obtain action potential properties from a raw .abf file in Clampfit.
vignette: >
  %\VignetteIndexEntry{Action Potential Analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  fig.align = "center",
  out.extra='',
  out.width="75%",
  echo = FALSE
)

library(dplyr)
library(reactable)
```

> Note: This package does not yet contain functions to analyze and plot action
potential data. However, I am including this vignette here to show you how to
perform raw data analysis in Clampfit. The resulting data will be ready to use
in future versions of *patchclampplotteR.*

This vignette will demonstrate how to analyze action potential properties using
a raw .abf file. You will identify the first current injection that resulted in
action potentials and then select the first action potential within this sweep
for further analyses.

```{r header-image, fig.alt = "An image of a current clamp steps recording with the first action potential outlined with a box.", fig.cap = "The box outlines the first action potential on the first sweep with action potentials."}
knitr::include_graphics("figures/AP-first-trace.png")
```

> You will identify the threshold using the first derivative method. This means
that the threshold corresponds to the membrane potential where the action
potential velocity is 10 mV/ms or greater (Farries et al., 2010).

## Set up data sheet

Before you begin, you should set up a .csv file with the following columns: 

* `Letter` The unique letter identifier of a single cell. You can use this to link data from different recordings taken from the same cell.
* `State` A character value. In this example, the values are `Baseline` and `Insulin`, indicating a current clamp protocol taken after the cell had been exposed to 500 nM insulin for 25 minutes.
* `Time_of_threshold` A numerical value (in ms) used to determine properties like the latency to fire.
* `t_x` The membrane potential at the moment that an action potential is initiated, also known as the threshold.
* `t11` The derivative of the trace you are analyzing. Must be 10 mV/ms or greater to properly identify the threshold.
* `ID` A character value indicating the recording number. This corresponds to the `File Name` column that is automatically generated in the Results sheet in Clampfit.
* `First_sweep_with_APs` A number representing the earliest sweep number where action potentials first appeared.
* `Trace_start` This is an automatic value calculated by Clampfit, and it corresponds to the sweep number. It is not used in any analyses, but it will automatically be included in the Results sheet in Clampfit. It's faster to just copy all the data rather than try to exclude this value.
* `Peak_amplitude` The membrane potential (in mV) during maximum depolarization.
* `Time_to_peak`The time of the peak amplitude (in ms), which should also be relative to the `Time_of_threshold` if you have repositioned Cursor 1 to the `Time_of_threshold`.
* `Antipeak_amplitude` The afterhyperpolarization amplitude (in mV)
* `Time_of_antipeak` The time of the after-hyperpolarization (in ms), which should be relative to the `Time_of_threshold`.
* `Half-width` The width of the action potential when the membrane potential is half of the `Peak_amplitude`.

```{r ap-properties-image, fig.alt = "An image of an action potential with labels indicating properties such as the peak amplitude, half-width, after-hyperpolarization, and latency to fire."}
knitr::include_graphics("figures/AP-properties.png")
```

## Get derivative

1. Open the .abf file containing the current clamp step protocol in Clampfit. Ensure that the x-axis shows time in milliseconds. If it shows seconds, double-click the x-axis, and change the `Elapsed Time` from `Automatic` to `Milliseconds`.
2. Press the “Enter” key to show just one sweep at a time. It will begin at the sweep corresponding to the lowest current injection. Use greater than symbol (>; on some computers you don’t even need to press the shift key) to cycle up through the sweeps.
3. Move up to sweeps corresponding to higher current injections until you identify the first sweep that contains an action potential. I will call this `t_x`, since it may be `t5` in one recording, or `t6` in another, etc. 
4. Position Cursors 1 and 2 around the first action potential in `t_x`. Cursor 1 should be before the threshold (aim for the area before the slope of the curve increases steeply). Cursor 2 should be in the after-hyperpolarization region.

> It is important that Cursor 2 touches the curve at a value that is lower than
the voltage value for Cursor 1. If Cursor 1 is lower, then Clampfit may identify
the location at Cursor 1 as the after-hyperpolarization region if you forget to
move the cursor to the threshold (see step 11).

```{r cursor-image, fig.alt = "A screenshot of Clampfit showing cursors positioned around the first action potential. The first cursor is located at a point with a y-axis value that is greater than Cursor 2."}
knitr::include_graphics("figures/AP-cursors.png")
```

5. Click on the arithmetic button (it is the button with basic math symbols), then Add Traces. Write "1" and click OK. This will add a new empty trace, called `t11`.

6. `t11` should be the derivative of `t_x`. In the `Expression` box, write `t11=diff(t6)` (replace `t6` with your value for `t_x`). 

```{r expression-image, fig.alt = "A screenshot of the Arithmetic box of Clampfit showing the formula t11=diff(t6) inserted into the expression field."}
knitr::include_graphics("figures/AP-expression-box.png")
```

## Find threshold

7. Click on `Edit` -> `Transfer Traces` and set the `Region to transfer` as `Cursors 1..2`. In the `Trace Selection` category, choose only `Vm_primary ()` as the signal. Select `t_x` and `t11` for the traces, then click OK.

8. The `Results` page will display three columns: `Time (ms)`, `Trace #6 (or #5, #7, etc.)`, and `Trace #11`. `Trace #x` is the membrane potential in mV, and `Trace #11` is the derivative of `Trace #x`.

> Warning: The Results page of the transferred traces does not delete data between
files. If you are doing several analyses in one session, ensure that you are
looking at the correct columns corresponding to the active
recording.

9. Scroll down the `Trace #11` column (the derivative column) until you see the
first value that is greater than or equal to 10 mV/ms. Copy the value of all
three columns.

10. Your .csv file should now look like this:

```{r sample-ap-table-one}
sample_ap_data <- data.frame(
  Letter = c("BN"),
  State	= c("Baseline"),
  Time_of_threshold = c(373.50),
  t_x = c(-32.10),
  t11 = c(10.38)
)

reactable(sample_ap_data)
```

## Measure action potential properties

11. Double-click on Cursor 1 and change its x-position value (`Time`) to match the
`Time_of_threshold`.

```{r cursor-image-revised, fig.alt = "A screenshot of Clampfit showing cursors positioned around the first action potential. The first cursor is now located at the x-value where the membrane potential is equal to the threshold.", fig.cap = "Note how Cursor 1 is shifted to the right relative to the earlier cursor image. It is now located at the x-value where the membrane potential crosses the threshold."}
knitr::include_graphics("figures/AP-cursors-new.png")
```

> Warning! If you do not reposition Cursor 1 to be at the time of threshold, the
values for `Time_of_peak` and `Time_of_antipeak` will be incorrect!

12. Click on the Statistics button (a small icon with a summation symbol on top
of it) or press `Alt+s`.

13. Set the following settings:

* Trace Selection: Choose `Vm_primary ()` and `t_x` (in this case, `t6`)
* Peak Polarity: `Vm_primary`, `Positive-going`
* Baseline Region: Fixed at `[paste in the threshold value (column t_x in your sheet) here]`
* Search Region 1: Range: `Cursors 1..2`
* Destination Option: `Replace results in sheet` (prevents you from accidentally copying old data
* Column Order: `Measurement, region, Signal`
* Measurements: `Peak_amplitude`, `Time of peak`, `Antipeak amplitude`, `Time of antipeak`, `Half-width`

```{r statistics-box, fig.alt = "A screenshot of the Statistics box of Clampfit showing the correct options to select."}
knitr::include_graphics("figures/AP-statistics-box.png")
```

14. Select all data except for the filepath option (unless you think you will
need it later) and paste it into the .csv file. You'll notice that the .csv
column names are different than the column names in the `Results` sheet. I
changed these column names to make them easier to use in R code.

15. Your .csv file should now look like this.

```{r finalized-ap-table}
sample_ap_data_2 <- data.frame(
  Letter = c("BN"),
  State	= c("Baseline"),
  Time_of_threshold = c(373.50),
  t_x = c(-32.10),
  t11 = c(10.38),
  ID = c("23711003.abf"),
  First_sweep_with_APs = c(6),
  Trace_start = c(5021),
  Peak_amplitude = c(72.54),
  Time_to_peak = c(0.7),
  Antipeak_amplitude = c(-17.73),
  Time_of_antipeak = c(4.4),
  Half_width = c(1.09)
)

reactable(sample_ap_data_2)
```

16. Repeat this process for the current clamp step protocol taken after a
hormone or treatment.

> If there are no action potentials in the later recording, insert the values
for the columns `Letter` and `State` and leave all the others blank.


Here is an example of what a datasheet can look like:

```{r example-full-ap-table}
sample_full_ap_table <- read.csv("sample-ap-data.csv") %>% 
  mutate(across(where(is.numeric), round, 2))

reactable(sample_full_ap_table)
```

## Count action potentials

The next step is to count the number of action potentials in each sweep. This
will allow you to later make a plot of action potential frequency vs. current
injection and see how a treatment affect action potential frequency.
For this, you will need a separate .csv file with four columns:

* `Letter` The unique letter identifier of a single cell.
* `State` A character value ("Baseline" or "Insulin" in this example)
* `Sweep` A number from 1 to 10
* `No_of_APs` a numerical value indicating the number of action potentials

17. Press the `Enter` key and use `,` and `.` (or `<` and `>`) to cycle through
the sweeps. Count the number of action potentials in each sweep.


18. Here is an example of what one recording could look like:


```{r display-sample-count-data}
reactable(read.csv("sample-ap-count-data.csv"))
```

## FAQ

*What do I do if there are no action potentials following treatment?*

Do not discard this cell; this is important and meaningful data! Fill in only
the letter and state, and leave all other columns blank. R will fill this with
NA values, since there are no action potential properties to measure. However,
for your AP count data, please just indicate `0` for all current injections.

*What do I do if there are action potentials outside of the time when a current injection was applied?*

```{r aps-outside, fig.alt = "A screenshot of a recording in Clampfit showing action potentials present outside of the range where a current injection was applied."}
knitr::include_graphics("figures/APs-outside-sweep.png")
```

This can happen with very excitable cells. Only count the action potentials that
occurred within the injection period.

*Should I count an action potential that looks very wavy?*

```{r aps-wavy, fig.alt = "A screenshot of a recording in Clampfit showing wavy action potentials. Valid action potentials are indicated with check marks"}
knitr::include_graphics("figures/Wavy-APs-check.png")
```

Only include the action potential if it clearly crosses the threshold, comes to
a sharp peak, and has an after-hyperpolarization period.

References

Farries, M. A., Kita, H., & Wilson, C. J. (2010). Dynamic Spike Threshold and
Zero Membrane Slope Conductance Shape the Response of Subthalamic Neurons to
Cortical Input. Journal of Neuroscience, 30(39), 13180–13191.
https://doi.org/10.1523/JNEUROSCI.1909-10.2010
